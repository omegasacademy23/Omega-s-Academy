<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Omega's Academy : Tutor's Dashboard</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link href="img/icon.png" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600&family=Nunito:wght@600;700;800&display=swap"
        rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link href="lib/animate/animate.min.css" rel="stylesheet">
    <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="css/style.css" rel="stylesheet">
</head>

<body>
    <!-- Navbar Start -->
    <nav class="navbar navbar-expand-lg bg-white navbar-light shadow sticky-top p-0">
        <a href="index.html" class="navbar-brand d-flex align-items-center px-4 px-lg-5">
            <p class="m-0 fw-bold" style="font-size: 25px;">
                <img src="img/icon.png" alt="" height="50px"> Omega's
                <span style="color: #6a1b9a;">Academy</span>
            </p>
        </a>

        <div class="ms-auto d-flex align-items-center px-4">
            <span id="welcomeMsg" class="fw-bold text-primary me-3"></span>
            <button id="logoutBtn" class="btn btn-outline-danger btn-sm">
                <i class="bi bi-box-arrow-right"></i> Logout
            </button>
        </div>
    </nav>
    <!-- Navbar End -->

    <!-- Dashboard Start -->
    <div class="container-xxl py-5">
        <div class="container">
            <div class="row g-5">
                <div class="col-lg-12 wow fadeInUp" data-wow-delay="0.3s">
                    <h6 class="section-title bg-white text-start pe-3">Daily Update</h6>
                    <h1 class="mb-4" style="color: #6a1b9a;">Tutor's Dashboard</h1>

                    <!-- Attendance Form -->
                    <div class="card shadow-sm p-4 mb-4">
                        <h4 class="fw-semi-bold mb-3"><i class="bi bi-clipboard-check me-2"></i>Record Attendance</h4>
                        <form id="attendanceForm">
                            <!-- Course Dropdown -->
                            <div class="mb-3">
                                <label for="course" class="form-label">Select Course</label>
                                <select id="course" class="form-control" required>
                                    <option value="">-- Choose Course --</option>
                                    <option value="Mathematics">Mathematics</option>
                                    <option value="Physics">Physics</option>
                                    <option value="Chemistry">Chemistry</option>
                                    <option value="Biology">Biology</option>
                                    <option value="Computer Science">Computer Science</option>
                                </select>
                            </div>

                            <!-- Date & Time -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="classDate" class="form-label">Date of Class</label>
                                    <input type="date" id="classDate" class="form-control" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="classTime" class="form-label">Time</label>
                                    <input type="time" id="classTime" class="form-control" required>
                                </div>
                            </div>

                            <!-- Student Attendance -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="presentCount" class="form-label">No. of Students Present</label>
                                    <input type="number" id="presentCount" class="form-control" min="0" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="absentCount" class="form-label">No. of Students Absent</label>
                                    <input type="number" id="absentCount" class="form-control" min="0" required>
                                </div>
                            </div>

                            <!-- Names of Absentees -->
                            <div class="mb-3">
                                <label for="absentees" class="form-label">Names of Absentees</label>
                                <textarea id="absentees" class="form-control" rows="2"
                                    placeholder="Enter names of absentees"></textarea>
                            </div>

                            <!-- Class Title -->
                            <div class="mb-3">
                                <label for="classTitle" class="form-label">Title of Class</label>
                                <input type="text" id="classTitle" class="form-control" placeholder="Enter class title"
                                    required>
                            </div>

                            <!-- Class Description -->
                            <div class="mb-3">
                                <label for="classDesc" class="form-label">Description of Class</label>
                                <textarea id="classDesc" class="form-control" rows="3"
                                    placeholder="Enter details of todayâ€™s class"></textarea>
                            </div>

                            <!-- Next Day Preplan -->
                            <div class="mb-3">
                                <label for="nextPlan" class="form-label">Next Day's Preplan</label>
                                <textarea id="nextPlan" class="form-control" rows="3"
                                    placeholder="Enter what will be covered in the next class"></textarea>
                            </div>

                            <button type="submit" class="btn btn-primary px-4">Save Attendance</button>
                        </form>
                    </div>

                    <!-- Attendance Records -->
                    <div class="card shadow-sm p-4">
                        <h4 class="fw-semi-bold mb-3"><i class="bi bi-journal-text me-2"></i>Saved Attendance Records</h4>
                        <ul id="attendanceList" class="list-group"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Dashboard End -->

    <!-- Scripts -->
    <script>
        // âœ… Check if logged in & role is tutor
        const user = JSON.parse(localStorage.getItem("loggedInUser"));
        if (!user || user.role.toLowerCase() !== "tutor") {
            alert("Unauthorized access! Redirecting to login.");
            window.location.href = "login.html";
        }

        // Show welcome message
        document.getElementById("welcomeMsg").innerText = "Welcome, " + user.username;

        // Logout
        document.getElementById("logoutBtn").addEventListener("click", () => {
            localStorage.removeItem("loggedInUser");
            window.location.href = "login.html";
        });

        // Auto-fill date & time when page loads
        window.addEventListener("DOMContentLoaded", () => {
            const today = new Date();
            document.getElementById("classDate").value = today.toISOString().split("T")[0];
            document.getElementById("classTime").value = today.toTimeString().slice(0, 5);

            // Fetch previous attendance records from SheetDB
            fetchAttendanceRecords();
        });

        // Function to fetch records from SheetDB
        async function fetchAttendanceRecords() {
            const sheetdbUrl = "https://sheetdb.io/api/v1/co7vcrvr1t07t"; // ðŸ”‘ Your SheetDB URL

            try {
                const response = await fetch(sheetdbUrl);
                const data = await response.json();

                // Filter records for the logged-in tutor
                const tutorRecords = data.filter(record => record.tutor === user.username);

                const attendanceList = document.getElementById("attendanceList");
                attendanceList.innerHTML = ""; // Clear existing list

                tutorRecords.forEach(record => {
                    appendAttendanceToUI(record);
                });

            } catch (error) {
                console.error("Error fetching attendance records:", error);
                alert("Could not retrieve previous attendance records.");
            }
        }

        // Function to append a single record to the UI
        function appendAttendanceToUI(record) {
            const li = document.createElement("li");
            li.className = "list-group-item";
            li.innerHTML = `
                <strong>${record.course}</strong><br>
                ${record.date} | ${record.time}<br>
                <em>${record.title}</em><br>
                <small><b>Present:</b> ${record.present}, <b>Absent:</b> ${record.absent}</small><br>
                <small><b>Absentees:</b> ${record.absentees || 'None'}</small><br>
                <small><b>Description:</b> ${record.description}</small><br>
                <small><b>Next Plan:</b> ${record.next_plan}</small>
            `;
            document.getElementById("attendanceList").appendChild(li);
        }

        // Attendance form logic
        document.getElementById("attendanceForm").addEventListener("submit", async function (e) {
            e.preventDefault();

            // Get form data
            const record = {
                tutor: user.username,
                course: document.getElementById("course").value,
                date: document.getElementById("classDate").value,
                time: document.getElementById("classTime").value,
                present: document.getElementById("presentCount").value,
                absent: document.getElementById("absentCount").value,
                absentees: document.getElementById("absentees").value,
                title: document.getElementById("classTitle").value,
                description: document.getElementById("classDesc").value,
                next_plan: document.getElementById("nextPlan").value
            };

            // Save to SheetDB
            try {
                const sheetdbUrl = "https://sheetdb.io/api/v1/co7vcrvr1t07t"; // ðŸ”‘ Your SheetDB URL
                await fetch(sheetdbUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ data: [record] })
                });

                // âœ… Append record to UI instantly
                appendAttendanceToUI(record);
                alert("Attendance saved successfully!");

            } catch (error) {
                console.error("Error saving to SheetDB:", error);
                alert("Error saving attendance. Please try again.");
            }

            // Reset form but keep date & time auto-filled
            e.target.reset();
            const today = new Date();
            document.getElementById("classDate").value = today.toISOString().split("T")[0];
            document.getElementById("classTime").value = today.toTimeString().slice(0, 5);
        });
    </script>
</body>
</html>
